<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=description content="Hacker, writer, good guy."><link rel=alternate type=application/rss+xml title="Travis Jeffery's Blog Feed" href=https://travisjeffery.com/rss.xml><meta property="og:type" content="article"><meta property="og:title" content="Using PostgreSQL's Hstore with Rails"><meta property="og:description" content="Prelude
Recently I implemented a piece of functionality that used PostgreSQL&rsquo;s hstore
data type in a Rails application and I&rsquo;d like to share how we did it including
some improvements you can make to use data stored as an hstore easier.
hstore is PostgreSQL data type similar to integer, date and text, but
unlike these atomic data types hstore stores key/value pairs within a single
PostgreSQL value.
Hashes/dictionaries are the most used data structure in computer science and
programming so having them as a data type in a database is massively
powerful with many use cases, e.g. dynamic columns."><meta property="article:published_time" content="2012-02-20T00:00:00Z"><meta property="article:modified_time" content="2012-02-20T00:00:00Z"><meta property="og:url" content="https://travisjeffery.com/posts/2012-02-20-using-postgress-hstore-with-rails/"><meta property="og:site_name" content="Travis Jeffery's Blog"><meta property="og:locale" content="en_US"><meta name=twitter:site content="@travisjeffery"><meta name=twitter:text:title content="Using PostgreSQL's Hstore with Rails"><meta name=twitter:image content="https://s.gravatar.com/avatar/3ee6c3893e75232ed43ed4e8e9a7cf39"><meta name=twitter:card content="summary"><link href=https://travisjeffery.com/css/style.min.5320ccbdfe5c8b65316b0017a872de5cb86715d4fe7fec778fefa42ea3262c3b.css rel=stylesheet><script src=https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js></script><script src=/js/judy.min.js type=text/javascript></script><script src=/js/main.js type=text/javascript></script><link href="https://fonts.googleapis.com/css?family=Fira+Code:400,700|Libre+Caslon+Text:400,400i,700&display=swap" rel=stylesheet><link rel=stylesheet href=//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.9.1/styles/github.min.css type=text/css media=screen><script>(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)})(window,document,"script","//www.google-analytics.com/analytics.js","ga"),ga("create","UA-8462120-1","travisjeffery.com"),ga("send","pageview")</script><title>Using PostgreSQL's Hstore with Rails</title></head><body><div class="container-fluid container"><div class=row><div class="col-xs-12 col-lg-8 col-lg-offset-2"><hgroup id=header class="col-xs-12 no-gutters clearfix"><img class="no-gutters col-xs-3 col-sm-1" src="https://s.gravatar.com/avatar/3ee6c3893e75232ed43ed4e8e9a7cf39?s=80"><h1 class="logo no-gutters col-xs-4 col-sm-6"><a href=/>travis jeffery</a></h1><div class="social no-gutters col-xs-6 col-sm-5 pull-right"><div class="no-gutters col-xs-12"><a href=/subscribe>Subscribe</a></div><div class="no-gutters col-xs-12"><a href=https://github.com/travisjeffery>GitHub</a></div><div class="no-gutters col-xs-12"><a href=https://twitter.com/travisjeffery>Twitter</a></div></div></hgroup><hr class="col-xs-12 no-gutters"><article class="col-xs-12 no-gutters"><header><h1 class=article-title><a href=https://travisjeffery.com/posts/2012-02-20-using-postgress-hstore-with-rails/>Using PostgreSQL's Hstore with Rails</a></h1></header><h2 id=prelude>Prelude</h2><p>Recently I implemented a piece of functionality that used PostgreSQL&rsquo;s hstore
data type in a Rails application and I&rsquo;d like to share how we did it including
some improvements you can make to use data stored as an hstore easier.</p><p>hstore is PostgreSQL data type similar to integer, date and text, but
unlike these atomic data types hstore stores key/value pairs within a single
PostgreSQL value.</p><p>Hashes/dictionaries are the most used data structure in computer science and
programming so having them as a data type in a database is massively
powerful with many use cases, e.g. dynamic columns.</p><p>Rails can actually already do this by adding a text field to a table and
calling serialize like so:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span><span style=color:#cf222e>class</span> <span style=color:#1f2328>MyModel</span> <span style=color:#0550ae>&lt;</span> <span style=color:#0550ae>ActiveRecord</span><span style=color:#0550ae>::</span><span style=color:#0550ae>Base</span>
</span></span><span style=display:flex><span>  serialize <span style=color:#032f62>:field</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>Hash</span>
</span></span><span style=display:flex><span><span style=color:#cf222e>end</span>
</span></span></code></pre></div><p>The problem with this is that a field stored and serialized in this manner will not
support indexing and lookups will be very slow. hstore on the other hand does support indexing.</p><p><img src="https://docs.google.com/spreadsheet/oimg?key=0At-PylhYQ8Q0dDVlblluWW1kQUxpZWUyZElLMVJCUmc&amp;oid=1&amp;zx=jfvyr8xso2hq" alt=Graph></p><h2 id=using-hstore-with-rails-today>Using hstore with rails today</h2><p>Any Rails version &lt; v4.0/master does not support hstore out of
the box. Thankfully there&rsquo;s a gem: <a href=https://github.com/softa/activerecord-postgres-hstore>activerecord-postgres-hstore</a>
that provides support. See the project&rsquo;s README on GitHub for installation
instructions.</p><h2 id=usage>Usage</h2><h3 id=creating-an-entity>Creating an entity</h3><p>I&rsquo;m going to create a person model that has a preferences field stored as an
hstore.</p><p><code>rails g model Person name:string preferences:hstore</code></p><p><code>rake db:migrate</code></p><p><code>CREATE INDEX people_gin_preferences ON people USING GIN(preferences);</code></p><h3 id=storage-and-retrieval>Storage and retrieval</h3><p>Now we have our Person entity and we can use it with <code>@travis.preferences["key"]</code> like so, serialization/deserialization is handled
for us:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span><span style=color:#6639ba>require</span> <span style=color:#0a3069>&#39;test_helper&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#cf222e>class</span> <span style=color:#1f2328>PersonTest</span> <span style=color:#0550ae>&lt;</span> <span style=color:#0550ae>ActiveSupport</span><span style=color:#0550ae>::</span><span style=color:#0550ae>TestCase</span>
</span></span><span style=display:flex><span>  <span style=color:#cf222e>def</span> <span style=color:#6639ba>setup</span>
</span></span><span style=display:flex><span>    <span style=color:#953800>@travis</span> <span style=color:#0550ae>=</span> <span style=color:#0550ae>Person</span><span style=color:#0550ae>.</span>create <span style=color:#032f62>:name</span> <span style=color:#0550ae>=&gt;</span> <span style=color:#0a3069>&#34;Travis Jeffery&#34;</span><span style=color:#1f2328>,</span> <span style=color:#032f62>:preferences</span> <span style=color:#0550ae>=&gt;</span> <span style=color:#1f2328>{</span><span style=color:#0a3069>&#34;private?&#34;</span> <span style=color:#0550ae>=&gt;</span> <span style=color:#cf222e>true</span><span style=color:#1f2328>,</span> <span style=color:#0a3069>&#34;location&#34;</span> <span style=color:#0550ae>=&gt;</span> <span style=color:#0a3069>&#34;Toronto, Ontario&#34;</span><span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span>  <span style=color:#cf222e>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#6639ba>test</span> <span style=color:#0a3069>&#34;accessing preferences&#34;</span> <span style=color:#cf222e>do</span>
</span></span><span style=display:flex><span>    assert_equal <span style=color:#cf222e>true</span><span style=color:#1f2328>,</span> <span style=color:#953800>@travis</span><span style=color:#0550ae>.</span>preferences<span style=color:#0550ae>[</span><span style=color:#0a3069>&#34;private?&#34;</span><span style=color:#0550ae>]</span>
</span></span><span style=display:flex><span>    assert_equal <span style=color:#0a3069>&#34;Toronto, Ontario&#34;</span><span style=color:#1f2328>,</span> <span style=color:#953800>@travis</span><span style=color:#0550ae>.</span>preferences<span style=color:#0550ae>[</span><span style=color:#0a3069>&#34;location&#34;</span><span style=color:#0550ae>]</span>
</span></span><span style=display:flex><span>  <span style=color:#cf222e>end</span>
</span></span><span style=display:flex><span><span style=color:#cf222e>end</span>
</span></span></code></pre></div><h2 id=improving-the-api>Improving the api</h2><p>This API is not very nice and has bad encapsulation, how much cooler would
it be to be able to just use <code>@travis.private?</code> or <code>@travis.location</code>? Here&rsquo;s
how:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span><span style=color:#cf222e>class</span> <span style=color:#1f2328>Person</span> <span style=color:#0550ae>&lt;</span> <span style=color:#0550ae>ActiveRecord</span><span style=color:#0550ae>::</span><span style=color:#0550ae>Base</span>
</span></span><span style=display:flex><span>  <span style=color:#cf222e>def</span> <span style=color:#6639ba>method_missing</span><span style=color:#1f2328>(</span><span style=color:#6639ba>id</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>*</span>args<span style=color:#1f2328>,</span> <span style=color:#0550ae>&amp;</span>block<span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>if</span> preferences<span style=color:#0550ae>.</span>has_key?<span style=color:#1f2328>(</span><span style=color:#6639ba>id</span><span style=color:#0550ae>.</span>to_s<span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span>      preferences<span style=color:#0550ae>.</span>fetch<span style=color:#1f2328>(</span><span style=color:#6639ba>id</span><span style=color:#0550ae>.</span>to_s<span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>else</span>
</span></span><span style=display:flex><span>      <span style=color:#cf222e>super</span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>end</span>
</span></span><span style=display:flex><span>  <span style=color:#cf222e>end</span>
</span></span><span style=display:flex><span><span style=color:#cf222e>end</span>
</span></span></code></pre></div><h2 id=issues>Issues</h2><p><code>PG::Error: ERROR: type "hstore" does not exist</code></p><h2 id=schema-loaddump>Schema load/dump</h2><p>One problem you may run into is when you try to <code>rake db:test:prepare</code> is that
Rails will not be able to load the schema properly since it doesn&rsquo;t support
hstore yet, to fix this you can either dump to sql by uncommenting or adding to your
application configuration in config/application.rb:</p><p><code>config.active_record.schema_format = :sql</code></p><p>Or make similar <a href=https://github.com/rails/rails/pull/4896>changes</a> to what&rsquo;s
in master right now in a config/initializer or something and then delete
that initializer when you upgrade to 4.0.</p><h2 id=add-hstore-to-your-template-database>Add hstore to your template database</h2><p>Another issue is that when you ran the migration to create the hstore data type to
your database, it was only added to the database for your current environment.</p><p>This will be okay for development and production, but if you drop your test
database and create it again you won&rsquo;t have the hstore data type, so to fix this
create the hstore data type on your template1 database:</p><p><code>psql -f PATH/hstore.sql -d template1</code></p><p>You can find this hstore.sql find usually within PostgreSQL&rsquo;s contrib folder on
your system.</p><h2 id=using-hstore-with-rails-in-the-future>Using hstore with rails in the future</h2><p>Full support for hstore is in Rails master and will likely be in Rails v4.0. So
if you&rsquo;re on master you shouldn&rsquo;t don&rsquo;t need to worry about any these issues other than making sure your
database does actually have the hstore data type. I would recommend improving the API and encapsulation as I&rsquo;ve done above too.</p><p>It&rsquo;s an exciting time to be PostgreSQL and Rails developer!</p><h2 id=further-reading>Further reading:</h2><ul><li>PostgreSQL&rsquo;s <a href=http://www.postgresql.org/docs/9.1/static/hstore.html>reference documentation</a> on hstore</li><li>More on PostgreSQL&rsquo;s template databases and how creating a database in
PostgreSQL works <a href=http://www.postgresql.org/docs/8.1/static/manage-ag-templatedbs.html>here</a>.</li></ul></article><hr class="col-xs-12 no-gutters"><footer id=post-footer class="col-xs-12 no-gutters"><p><span class=post-footer-item>Share <a href=https://twitter.com/share class=twitter-share-button data-via=travisjeffery data-size=large>Tweet about this article</a>
<script>!function(e,t,n){var s,o=e.getElementsByTagName(t)[0],i=/^http:/.test(e.location)?"http":"https";e.getElementById(n)||(s=e.createElement(t),s.id=n,s.src=i+"://platform.twitter.com/widgets.js",o.parentNode.insertBefore(s,o))}(document,"script","twitter-wjs")</script></span><span class=post-footer-item>Written Feb 20, 2012</span>
<span class=post-footer-item>Tags <a href=/tags/postgres>postgres</a></span>
<span class=post-footer-item><a href=/>Read more posts&#8230;</a></span></p></footer><hr class="col-xs-12 no-gutters"><footer class="footer col-xs-12 no-gutters left"><div class="col-xs-12 col-sm-4 pull-sm-left no-gutters"><a href=https://twitter.com/travisjeffery class=twitter-follow-button data-show-count=false data-size=large>Follow @travisjeffery</a>
<script>!function(e,t,n){var s,o=e.getElementsByTagName(t)[0];e.getElementById(n)||(s=e.createElement(t),s.id=n,s.src="//platform.twitter.com/widgets.js",o.parentNode.insertBefore(s,o))}(document,"script","twitter-wjs")</script><div class="no-gutters col-xs-12"><a href=https://twitter.com/travisjeffery>Twitter</a></div><div class="no-gutters col-xs-12"><a href=https://github.com/travisjeffery>GitHub</a></div><div class="no-gutters col-xs-12"><a href=mailto:tj@travisjeffery.com>Email</a></div><div class="no-gutters col-xs-12"><a href=https://travisjeffery.com>Homepage</a></div></div><div class="subscribe col-xs-12 col-sm-8 no-gutters pull-sm-right"><p class=zero-margin><strong>Delivered straight to your inbox.</strong> One email per post. No spam.</p><form action="https://travisjeffery.us4.list-manage.com/subscribe/post?u=1e3ff7d7791b26a8f60b9f16c&amp;id=322d3e68e8" method=post id=mc-embedded-subscribe-form name=mc-embedded-subscribe-form class="validate one-margin" target=_blank novalidate><div id=mc_embed_signup_scroll><div class=mc-field-group><input placeholder="Your email address" type=email name=EMAIL class="required email" id=mce-EMAIL></div><div id=mce-responses class=clear><div class=response id=mce-error-response style=display:none></div><div class=response id=mce-success-response style=display:none></div></div><div style=position:absolute;left:-5e3px aria-hidden=true><input type=text name=b_1e3ff7d7791b26a8f60b9f16c_322d3e68e8 tabindex=-1></div><p class=clear><input type=submit value=Subscribe name=subscribe id=mc-embedded-subscribe class=button></p></div><p></form></div></footer></div></div></div></body></html>